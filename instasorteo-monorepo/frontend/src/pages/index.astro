---
import "../styles/global.css";
const apiUrl = '/api/stats';
---
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Sorteo Calendarios de Adviento</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <div id="conn" class="conn-banner">NO HAY CONEXIÃ“N</div>
    <div class="screen">
      <div class="bg-slideshow"><div></div><div></div><div></div></div>
      <div class="overlay"></div>
      <main class="card">
        <header>
          <div class="badge">ğŸ„ Sorteo</div>
          <h1 class="h1">3 Calendarios de Adviento</h1>
          <p class="sub">
            ğŸ <b>1 Rimmel London</b> â€“ sorteo entre todos los comentarios.<br/>
            ğŸ <b>2 Technic</b> â€“ <b>2 personas que mÃ¡s comenten</b> (cierre dÃ­a 7 a las 12:00).
          </p>
        </header>
        <section class="grid">
          <div>
            <h2 class="h2">Requisitos</h2>
            <ul>
              <li>1ï¸âƒ£ Dale â¤ï¸ a esta publicaciÃ³n.</li>
              <li>2ï¸âƒ£ SÃ­gueme.</li>
              <li>3ï¸âƒ£ Comenta sin repetir (cada comentario cuenta).</li>
              <li>4ï¸âƒ£ Comparte en historias. Usuarios etiquetados vÃ¡lidos (no famosos).</li>
              <li>VÃ¡lido: ğŸ‡«ğŸ‡· ğŸ‡ªğŸ‡¸ ğŸ‡§ğŸ‡ª ğŸ‡©ğŸ‡ª ğŸ‡®ğŸ‡¹ ğŸ‡±ğŸ‡º ğŸ‡³ğŸ‡±</li>
            </ul>
            <h2 class="h2">Cuenta atrÃ¡s</h2>
            <div id="countdown" class="countdown">â€”</div>
          </div>
          <div>
            <h2 class="h2">Estado</h2>
            <div class="stat mono" id="total">0</div>
            <div class="sub">Comentarios vÃ¡lidos</div>
            <h2 class="h2">Top comentaristas (2)</h2>
            <ul id="top" class="list"></ul>
            <h2 class="h2">Ganadores</h2>
            <ul id="winners" class="list"></ul>
          </div>
        </section>
        <p class="footer">Solo mostramos nÃºmeros y ganadores (no el contenido de los comentarios).</p>
      </main>
    </div>
    <script>
      const showNoConn = (flag=true) => {
        const b = document.getElementById('conn');
        b.className = flag ? 'conn-banner show' : 'conn-banner';
      };
      async function load() {
        try {
          const res = await fetch('/api/stats', { cache: 'no-store' });
          if (!res.ok) { showNoConn(true); return; }
          const data = await res.json();
          if (data?.error) { showNoConn(true); return; }
          showNoConn(false);

          const total = document.getElementById('total');
          total.textContent = Intl.NumberFormat().format(data?.totales?.total_comentarios ?? 0);

          const ulTop = document.getElementById('top');
          ulTop.innerHTML = '';
          (data?.top2 ?? []).forEach((r, i) => {
            const li = document.createElement('li');
            li.className = 'row';
            li.innerHTML = `<span>${i+1}. @${r.nick}</span><span class="mono">${r.total_comentarios}</span>`;
            ulTop.appendChild(li);
          });

          const ulW = document.getElementById('winners');
          ulW.innerHTML = '';
          (data?.ganadores ?? []).forEach((g) => {
            let label = g.premio === 'RIMMEL_LONDON'
              ? 'ğŸ Rimmel (Sorteo)'
              : `ğŸ Technic (Top ${g.posicion_top})`;
            const li = document.createElement('li');
            li.className = 'row';
            li.innerHTML = `<span>${label}</span><span>@${g.nick}</span>`;
            ulW.appendChild(li);
          });

          const end = new Date(data?.concurso?.fecha_cierre);
          const el = document.getElementById('countdown');
          function tick() {
            const now = new Date();
            const diff = end - now;
            if (diff <= 0) { el.textContent = 'Recuento cerrado'; return; }
            const d = Math.floor(diff / (1000*60*60*24));
            const h = Math.floor(diff / (1000*60*60)) % 24;
            const m = Math.floor(diff / (1000*60)) % 60;
            const s = Math.floor(diff / 1000) % 60;
            el.textContent = `${d}d ${h}h ${m}m ${s}s`;
          }
          tick(); setInterval(tick, 1000);
        } catch (e) { console.error(e); showNoConn(true); }
      }
      load();
    </script>
  </body>
</html>
